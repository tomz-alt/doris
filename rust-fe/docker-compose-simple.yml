version: '3.8'

services:
  # Backend Node
  doris-be:
    image: apache/doris:be-4.0.1
    container_name: doris-be
    hostname: doris-be
    environment:
      - FE_SERVERS=fe1:172.20.80.2:9010
      - BE_ADDR=172.20.80.3:9050
    ports:
      - "8040:8040"  # BE webserver
      - "9060:9060"  # BE heartbeat port
      - "8060:8060"  # BE brpc port
      - "9050:9050"  # BE service port
    volumes:
      - be-data:/opt/apache-doris/be/storage
      - be-log:/opt/apache-doris/be/log
    networks:
      doris-network:
        ipv4_address: 172.20.80.3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8040/api/health"]
      interval: 10s
      timeout: 5s
      retries: 10
    ulimits:
      nofile:
        soft: 65536
        hard: 65536

  # Java FE (for comparison)
  doris-fe-java:
    image: apache/doris:fe-4.0.1
    container_name: doris-fe-java
    hostname: doris-fe-java
    environment:
      - FE_SERVERS=fe1:172.20.80.2:9010
      - FE_ID=1
    ports:
      - "8030:8030"  # HTTP port
      - "9030:9030"  # MySQL port
      - "9010:9010"  # Edit log port
    volumes:
      - fe-java-data:/opt/apache-doris/fe/doris-meta
      - fe-java-log:/opt/apache-doris/fe/log
    networks:
      doris-network:
        ipv4_address: 172.20.80.2
    healthcheck:
      test: ["CMD", "mysql", "-h", "127.0.0.1", "-P", "9030", "-u", "root", "-e", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 20

  # Rust FE (built locally, copied into simple container)
  doris-fe-rust:
    image: doris-rust-fe:local
    container_name: doris-fe-rust
    hostname: doris-fe-rust
    environment:
      - FE_HTTP_PORT=8031
      - FE_RPC_PORT=9021
      - FE_QUERY_PORT=9031
      - FE_EDIT_LOG_PORT=9011
      - RUST_LOG=info
      - BE_ADDR=172.20.80.3:9050
      - FE_SERVERS=fe1:172.20.80.2:9010
    ports:
      - "8031:8031"  # HTTP port
      - "9031:9031"  # MySQL port
      - "9011:9011"  # Edit log port
      - "9021:9021"  # RPC port
    networks:
      doris-network:
        ipv4_address: 172.20.80.4

volumes:
  be-data:
  be-log:
  fe-java-data:
  fe-java-log:

networks:
  doris-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.80.0/24
